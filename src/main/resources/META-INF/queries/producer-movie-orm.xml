<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings version="2.1" xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm http://xmlns.jcp.org/xml/ns/persistence/orm_2_1.xsd">

	<named-native-query name="findProducersWithWinMoviesAtLeastTwice" 
		result-class="br.com.laersondev.goldenraspberryawardsapi.repository.dto.ProducerMovieWinRs" >
		<query><![CDATA[
			select
				prod.name,
				movie.title,
				movie.year
			from producer prod
				join movie_producer 
					on movie_producer.producer_id = prod.id
				join movie 
					on movie.id = movie_producer.movie_id 
			where movie.winner = true
			and exists (
				select mp.producer_id, count(*) from movie_producer mp
				where mp.movie_id = movie.id and mp.producer_id = prod.id
				group by mp.producer_id
				having count(*) >= 2
			) 
			group by prod.name, movie.year, movie.title
			order by prod.name, movie.year, movie.title
		]]></query>
	</named-native-query>	
</entity-mappings>
